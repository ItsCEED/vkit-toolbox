import keyboard
import time
import threading
from rich.console import Console

console = Console()

_run_lock = threading.Lock()
_abort_event = None
_running = False


def tap_key(key, hold_time=0.05, gap_time=0.05):  # Reduced gap
    try:
        keyboard.press(key)
        time.sleep(hold_time)
        keyboard.release(key)
    except:
        pass
    time.sleep(gap_time)


def tap_combo(keys, hold_time=0.05, gap_time=0.05):  
    try:
        for k in keys: 
            keyboard.press(k)
        time.sleep(hold_time)
        for k in reversed(keys): 
            keyboard.release(k)  
    except:
        pass
    time.sleep(gap_time)


def main(bbox=None, manager=None):
    """
    Job Warp exploit - TOGGLE behavior with countdown
    Press once to start, press again to cancel
    """
    global _abort_event, _running

    with _run_lock:
        # TOGGLE BEHAVIOR - if already running, cancel it
        if _running:
            if _abort_event and not _abort_event.is_set():
                _abort_event.set()
                if manager:
                    manager.show_notification("üöÄ Job Warp Cancelling...", "#f59e0b")
                console.print("‚è≥ Job Warp [bold yellow]CANCELLING[/bold yellow]...", style="yellow")
            return

        # Start fresh run
        _running = True
        _abort_event = threading.Event()
        abort_event = _abort_event

    try:
        if manager:
            manager.show_notification("üöÄ Job Warp Starting...", "#f59e0b", duration=2000)
        console.print("üöÄ Job Warp [bold green]STARTING[/bold green]...", style="green")
        
        # Sequence
        tap_key('space')
        tap_key('enter')
        tap_combo(['alt', 'f4'])

        # Wait 40 seconds with countdown
        total_seconds = 40
        console.print(f"‚è≥ Waiting [cyan]{total_seconds}[/cyan] seconds... (Press CTRL+ALT+J to cancel)", style="yellow")
        
        for remaining in range(total_seconds, 0, -1):
            # Update notification every second
            if manager:
                manager.show_notification(
                    f"üöÄ Job Warp Active - {remaining}s remaining",
                    "#f59e0b",
                    duration=1500  # Show for 1.5s so it doesn't flicker
                )
            
            # Check if cancelled
            if abort_event.wait(timeout=1.0):
                # Cancelled
                tap_key('esc')
                if manager:
                    manager.show_notification("üöÄ Job Warp Cancelled", "#ef4444", duration=3000)
                console.print("‚úó Job Warp [bold red]CANCELLED[/bold red]", style="red")
                console.print()
                return

        # Complete
        tap_key('esc')
        if manager:
            manager.show_notification("‚úì Job Warp Complete!", "#85BB65", duration=4000)
        console.print("‚úì Job Warp [bold green]COMPLETE[/bold green]!", style="green")
        console.print()

    except Exception as e:
        console.print(f"‚úó Job Warp error: {e}", style="red")
        if manager:
            manager.show_notification("‚úó Job Warp Error", "#ef4444", duration=3000)
        console.print()
    
    finally:
        with _run_lock:
            _running = False
            if _abort_event is abort_event:
                _abort_event = None
