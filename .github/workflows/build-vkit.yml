name: Build VKit Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*'
      - 'v*'
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (e.g., 3.1.0)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract version from main.py
      id: version
      run: |
        # Manual override for workflow_dispatch
        if ("${{ github.event.inputs.version_override }}" -ne "") {
          $VERSION_RAW = "${{ github.event.inputs.version_override }}"
          Write-Host "‚úì Using manual override: $VERSION_RAW"
        } else {
          # Extract VERSION from main.py (e.g., VERSION = "v2.6")
          $content = Get-Content main.py -Raw
          if ($content -match 'VERSION = "v([0-9.]+)"') {
            $VERSION_RAW = $matches[1]
            Write-Host "‚úì Found version in main.py: $VERSION_RAW"
          } else {
            Write-Error "Failed to extract version from main.py"
            exit 1
          }
        }
        
        # Count dots to determine format
        $DOT_COUNT = ($VERSION_RAW.ToCharArray() | Where-Object {$_ -eq '.'}).Count
        
        # Convert to 4-part version (required by Windows)
        switch ($DOT_COUNT) {
          0 { $VERSION_FULL = "$VERSION_RAW.0.0.0" }
          1 { $VERSION_FULL = "$VERSION_RAW.0.0" }
          2 { $VERSION_FULL = "$VERSION_RAW.0" }
          default { $VERSION_FULL = $VERSION_RAW }
        }
        
        # Set outputs
        echo "VERSION=$VERSION_FULL" >> $env:GITHUB_OUTPUT
        echo "VERSION_SHORT=$VERSION_RAW" >> $env:GITHUB_OUTPUT
        Write-Host "‚úì Final version: v$VERSION_RAW ‚Üí $VERSION_FULL"
      shell: pwsh
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    # Cache pip dependencies
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # Cache Nuitka build cache (huge speedup!)
    - name: Cache Nuitka build
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\Nuitka
          ~\.cache\Nuitka
          main.build
        key: ${{ runner.os }}-nuitka-${{ hashFiles('main.py', 'requirements.txt') }}-v2
        restore-keys: |
          ${{ runner.os }}-nuitka-
    
    # Cache C compiler (ccache for faster C compilation)
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-ccache-vkit
        max-size: 500M
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install nuitka ordered-set zstandard
        pip install -r requirements.txt
        
        # Verify installations
        Write-Host "`n‚úì Installed packages:"
        pip list | Select-String -Pattern "nuitka|pyyaml|rich|pynput|psutil|pywin32"
      shell: pwsh
    
    - name: Verify icon exists
      run: |
        if (!(Test-Path "icon.ico")) {
          Write-Warning "‚ö† icon.ico not found, build will use default icon"
        } else {
          $iconSize = (Get-Item "icon.ico").Length
          Write-Host "‚úì icon.ico found ($iconSize bytes)"
        }
      shell: pwsh
    
    - name: Build with Nuitka (Optimized)
      run: |
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "Building VKit v${{ steps.version.outputs.VERSION_SHORT }}" -ForegroundColor Cyan
        Write-Host "File version: ${{ steps.version.outputs.VERSION }}" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        # Set ccache path
        $env:CC = "ccache gcc"
        $env:CXX = "ccache g++"
        
        python -m nuitka `
          --standalone `
          --onefile `
          --windows-icon-from-ico=icon.ico `
          --windows-uac-admin `
          --enable-plugin=tk-inter `
          --include-data-dir=assets=assets `
          --output-filename=VKit.exe `
          --product-name="GTA V VKit Toolkit" `
          --product-version="${{ steps.version.outputs.VERSION }}" `
          --file-version="${{ steps.version.outputs.VERSION }}" `
          --file-description="GTA V VKit v${{ steps.version.outputs.VERSION_SHORT }}" `
          --copyright="2025-2026" `
          --company-name="VKit" `
          --trademarks="VKit" `
          --disable-console `
          --assume-yes-for-downloads `
          --show-progress `
          --show-memory `
          --jobs=2 `
          main.py
        
        Write-Host "`n‚úì Build completed!" -ForegroundColor Green
      shell: pwsh
    
    - name: Verify build output
      id: verify
      run: |
        if (Test-Path "VKit.exe") {
          Write-Host "‚úì Build successful! VKit.exe created" -ForegroundColor Green
          
          $file = Get-Item "VKit.exe"
          $sizeMB = [math]::Round($file.Length / 1MB, 2)
          $hash = (Get-FileHash "VKit.exe" -Algorithm SHA256).Hash
          
          Write-Host "  üì¶ File: VKit.exe"
          Write-Host "  üìä Size: $sizeMB MB"
          Write-Host "  üîñ Version: v${{ steps.version.outputs.VERSION_SHORT }}"
          Write-Host "  üìù File version: ${{ steps.version.outputs.VERSION }}"
          Write-Host "  üîê SHA256: $hash"
          
          # Save hash for release notes
          echo "SHA256=$hash" >> $env:GITHUB_OUTPUT
          echo "SIZE_MB=$sizeMB" >> $env:GITHUB_OUTPUT
          
          # Create checksum file
          "$hash  VKit.exe" | Out-File -FilePath "VKit.exe.sha256" -Encoding ASCII
          Write-Host "`n‚úì Checksum file created: VKit.exe.sha256"
        } else {
          Write-Error "‚úó Build failed! VKit.exe not found"
          exit 1
        }
      shell: pwsh
    
    - name: Rename files for release
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        $version = "v${{ steps.version.outputs.VERSION_SHORT }}"
        
        # Rename executable
        Copy-Item VKit.exe "VKit-$version.exe"
        Copy-Item VKit.exe.sha256 "VKit-$version.exe.sha256"
        
        Write-Host "‚úì Created release files:" -ForegroundColor Green
        Get-ChildItem VKit-$version.* | ForEach-Object {
          $size = [math]::Round($_.Length / 1KB, 2)
          Write-Host "  - $($_.Name) ($size KB)"
        }
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VKit-Windows-v${{ steps.version.outputs.VERSION_SHORT }}
        path: |
          VKit-v${{ steps.version.outputs.VERSION_SHORT }}.exe
          VKit-v${{ steps.version.outputs.VERSION_SHORT }}.exe.sha256
        retention-days: 90
        compression-level: 9
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          VKit-v${{ steps.version.outputs.VERSION_SHORT }}.exe
          VKit-v${{ steps.version.outputs.VERSION_SHORT }}.exe.sha256
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
        fail_on_unmatched_files: true
        name: VKit Toolkit v${{ steps.version.outputs.VERSION_SHORT }}
        body: |
          ## üöÄ VKit Toolkit v${{ steps.version.outputs.VERSION_SHORT }}
          
          GTA V enhancement toolkit with session control, automation tools, and heist solvers.
          
          ---
          
          ### üì¶ Download
          
          **Executable:** [`VKit-v${{ steps.version.outputs.VERSION_SHORT }}.exe`](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VKit-v${{ steps.version.outputs.VERSION_SHORT }}.exe)
          
          **File Info:**
          - üìä Size: `${{ steps.verify.outputs.SIZE_MB }} MB`
          - üîê SHA256: `${{ steps.verify.outputs.SHA256 }}`
          
          ---
          
          ### üìã Installation
          
          1. **Download** `VKit-v${{ steps.version.outputs.VERSION_SHORT }}.exe` from above
          2. **Right-click** ‚Üí **Run as Administrator** ‚ö†Ô∏è
          3. **First launch** may be slow (Windows Defender scanning)
          4. **Config file** auto-generates on first run (`config.yaml`)
          
          ---
          
          ### ‚ú® Key Features
          
          #### üõ°Ô∏è Session Control
          - **NOSAVE Mode** - Blocks save servers (test missions without consequences)
          - **Configurable Hotkeys** - Customize all shortcuts via `config.yaml`
          - **Focus Detection** - Auto-pause tools when Alt+Tab
          
          #### ü§ñ Automation Tools
          - **Fast Autoclicker** - 50 CPS for rapid inputs
          - **Snack Spammer** - Auto-heal during combat (hold TAB)
          - **Anti-AFK Bot** - Stay online without idle kick
          
          #### üéÆ Heist Assistance
          - **Casino Heist** - Fingerprint & Keypad solvers
          - **Cayo Perico** - Fingerprint & Voltage solvers
          - **Job Warp** - Instant mission teleport (if available)
          
          #### üé® UI/UX
          - **Overlay Manager** - Full or mini display modes
          - **Rich Console** - Colorful, informative output
          - **Update Checker** - Automatic version notifications
          
          ---
          
          ### üîê Security & Safety
          
          - ‚úÖ **Open Source** - Inspect code at [github.com/${{ github.repository }}](https://github.com/${{ github.repository }})
          - ‚úÖ **No Telemetry** - Zero data collection
          - ‚úÖ **Admin Required** - For firewall rule management only
          - ‚ö†Ô∏è **Use Responsibly** - Automation = ban risk in public sessions
          
          ---
          
          ### üêõ Troubleshooting
          
          **Hotkeys not working?**
          - Ensure GTA V is focused (`require_game_focus: true` in config)
          - Check for conflicts with Discord/OBS overlays
          - Enable debug mode: `Ctrl+Shift+D`
          
          **NOSAVE mode failing?**
          - Must run as Administrator
          - Check Windows Firewall isn't disabled
          - Verify IP in `config.yaml` matches your region
          
          **Config not saving?**
          - Config must be in same folder as `VKit.exe`
          - Check folder write permissions
          - Delete `config.yaml` to regenerate defaults
          
          ---
          
          ### üìù Configuration
          
          Edit `config.yaml` to customize:
          - Hotkey bindings
          - Focus detection behavior
          - Firewall settings
          - Tool auto-stop on unfocus
          
          **Full documentation:** See `config.yaml` comments
          
          ---
          
          ### üîÑ Changelog
          
          See auto-generated release notes below ‚¨áÔ∏è
          
          ---
          
          ### ‚öñÔ∏è Disclaimer
          
          This tool is for **educational and testing purposes**. Use at your own risk.
          - Not affiliated with Rockstar Games
          - May violate Terms of Service
          - Can result in account bans
          - No warranty provided
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build Summary
      if: always()
      run: |
        Write-Host "`n========================================" -ForegroundColor Cyan
        Write-Host "Build Summary" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "Version: v${{ steps.version.outputs.VERSION_SHORT }}"
        Write-Host "Status: ${{ job.status }}"
        Write-Host "Trigger: ${{ github.event_name }}"
        if (Test-Path "VKit.exe") {
          $size = [math]::Round((Get-Item "VKit.exe").Length / 1MB, 2)
          Write-Host "Output: VKit.exe ($size MB)"
        }
        Write-Host "========================================" -ForegroundColor Cyan
      shell: pwsh
